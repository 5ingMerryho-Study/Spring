# 서비스 추상화

## 사용자 레벨 관리 기능 추가
level 타입이 int이기 때문에 다른 종류의 정보를 넣는 실수를 해도 컴파일러가 체크해주지 못한지만 Enum 타입을 이용하면 안전하고 편리하다

JDBC가 사용하는 SQL은 SQL 문장이 완성돼서 DB에 전달되기 전까지는 문법 오류나 오타조차 발견하기 힘들다는 게 문제다.

자주 실행해볼 수 있도록 만들어진 테스트가 없는 채로 사용자 정보에 새로운 필드가 추가됐다면 어땠을까?

수정된 코드를 빌드하고 서버에 올려서 누군가 사용자의 정보를 읽고 쓰는 기능을 사용하기 전까지는 오타조차 발견하기 힘들 것이다.

### 코드 개선
작성된 코드를 살펴볼 때는 질문 사항이 있다.
- 코드에 중복된 부분은 없는가?
- 코드가 무엇을 하는 것인지 이해하기 불편하지 않은가?
- 코드가 자신이 있어야 할 자리에 있는가?
- 앞으로 변경이 일어난다면 어떤 것이 있을 수 있고, 그 변화에 쉽게 대응할 수 있게 작성되어 있는가?

## 트랜잭션 서비스 추상화
애플리케이션 내에서 트랜잭션이 시작되고 끝나는 위치를 "트랜잭션의 경계"라고 부른다.

setAutoCommit(false)로 트랜잭션의 시작을 선언하고 commit() 또는 rollback()으로 트랜잭션을 종료하는 작업을 "트랜잭션의 경계설정"이라고 한다.

이렇게 하나의 DB 커넥션 안에서 만들어지는 트랜잭션을 "로컬 트랜잭션"이라고도 한다.

"트랜잭션 동기화"란 트랜잭션을 시작하기 위해 만든 Connection 오브젝트를 특별한 저장소에 보관해두고, 이후에 호출되는 메소드에서 저장된 Connection을 가져다가 사용하는 것이다.

트랜잭션 동기화 저장소는 작업 스레드마다 독립적으로 Connection 오브젝트를 저장하고 관리하기 때문에 다중 사용자를 처리하는 서버의 멀티스레드 환경에서도 충돌이 날 염려는 없다.

## 서비스 추상화와 단일 책임 원칙
애플리케이션 로직의 종류에 따른 수평적인 구분이든, 로직과 기술이라는 수직적인 구분이든 모두 결합도가 낮으며, 서로 영향을 주지 않고 자유롭게 확장될 수 있는 구조를 만들 수 있는 데는 스프링의 DI가 중요한 역할을 하고 있다.

DI의 가치는 이렇게 관심, 책임, 성격이 다른 코드를 깔끔하게 분리하는 데 있다.

이런 적절한 분리가 가져오는 특징은 객체지향 설계의 원칙 중 하나인 "단일 책임 원칙"으로 설명할 수 있다.

단일 책임 원칙은 하나의 모듈은 한 가지 책임을 가져야 한다는 의미다.

하나의 모듈이 바뀌는 이유는 한 가지여야 한다고 설명할 수도 있다.

이렇게 단일 책임 원칙을 지키는 코드가 되면 어떤 장점이 있을까?

단일 책임 원칙을 잘 지키고 있다면, 어떤 변경이 필요할 때 수정 대상이 명확해진다.

기술이 바뀌면 기술 계층과의 연동을 담당하는 기술 추상화 계층의 설정만 바꿔주면 된다.

객체지향 설꼐와 프로그래밍의 원칙은 서로 긴밀하게 관련이 있다.

단일 책임 원칙을 잘 지키는 코드를 만들려면 인터페이스를 도입하고 이를 DI로 연결해야 하며, 그 결과로 단일 책임 원칙뿐 아니라 개방 폐쇄 원칙도 잘 지키고, 모듈 간에 결합도가 낮아서 서로의 변경이 영향을 주지 않고, 같은 이유로 변경이 단일 책임에 집중되는 응집도 높은 코드가 나온다.

이런 과정에서 다양한 디자인 패턴들도 적용된다.

## 정리
- 비즈니스 로직을 담은 코드는 데이터 엑세스 로직을 담은 코드와 깔끔하게 분리되는 것이 바람직하다.

  비즈니스 로직 코드 또한 내부적으로 책임과 역할에 따라서 깔끔하게 메소드로 정리돼야 한다.

- 이를 위해서는 DAO의 기술 변화에 서비스 계층의 코드가 영향을 받지 않도록 인터페이스와 DI를 잘 활용해서 결합도를 낮춰줘야 한다.

- DAO를 사용하는 비즈니스 로직에는 단위 작업을 보장해주는 트랜잭션이 필요하다.

- 트랜잭션의 시작과 종료를 지정하는 일을 트랜잭션 경계설정이라고 한다.
  트랜잭션 경계설정은 주로 비즈니스 로직 안에서 일어나는 경우가 많다.

- 시작된 트랜잭션 정보를 담은 오브젝트를 파라미터로 DAO에 전달하는 방법은 매우 비효율적이기 때문에 스프링이 제공하는 트랜잭션 동기화 기법을 활용하는 것이 편리하다.

- 환경과 서버에 따라서 트랜잭션 방법이 변경되면 경계설정 코드도 함께 변경돼야 한다.

- 트랜잭션 방법에 따라 비즈니스 로직을 담은 코드가 함께 변경되면 단일 책임 원칙에 위배되며, DAO가 사용하는 특정 기술에 대해 강한 경합을 만들어낸다.

- 트랜잭션 경계설정 코드가 비즈니스 로직 코드에 영향을 주지 않게 하려면 스프링이 제공하는 트랜잭션 서비스 추상화를 이용하면 된다.

- 테스트 대상이 사용하는 의존 오브젝틀르 대체할 수 있도록 만든 오브젝트를 테스트 대역이라고 한다.

- 테스트 대역은 테스트 대상 오브젝트가 원활하게 동작할 수 있도록 도우면서 테스트를 위해 간접적인 정보를 제공해주기도 한다.

- 테스트 대역 중에서 테스트 대상으로부터 전달받은 정보를 검증할 수 있도록 설계된 것을 목 오브젝트라고 한다.
